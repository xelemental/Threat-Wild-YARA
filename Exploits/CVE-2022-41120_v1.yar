rule sysmon_exploit {
    meta:
       author = "Elemental X"
       description = "Yara rule for detecting CVE-2022-41120"
       link = "https://github.com/Wh04m1001/SysmonEoP/tree/main/v1/"
       hash = "031c94831b0cd02922c9156fb86e27393082b278f7c065afc539894ac62afe1d"
       date = "2022-12-07"
    strings:
        // Creating the file AS NT/AUTHORITY
        $op1 = { 48 C7 44 24 30 00 00 00 00 C7 44 24 28 00 00 00 00 C7 44 24 20 03 00 00 00 45 33 C9 41 B8 07 00 00 00 BA 00 00 00 80 48 8D 0D 32 DB 00 00 FF 15 D4 83 01 00 48 89 45 28 }
        // Creating a thread as NT/AUTHORITY and trigger function as parameter
        $op2 = { 48 C7 44 24 28 00 00 00 00 C7 44 24 20 00 00 00 00 4C 8B 4D 08 4C 8D 05 F8 D7 FF FF 33 D2 33 C9 FF 15 D4 83 01 00 }
        //AddPrinterdriver function adding malicious printer driver using WMI 
        $op3 = { 48 8B 45 48 48 8B 00 48 C7 44 24 38 00 00 00 00 48 8D 8D 68 01 00 00 48 89 4C 24 30 48 8B 8D E8 00 00 00 48 89 4C 24 28 48 C7 44 24 20 00 00 00 00 45 33 C9 4C 8B 45 68 48 8B 95 88 00 00 00 48 8B 4D 48 }
        // Creates a junction between sysmon and RPC Control and clipboardchangevent exploitation 
        $op4 = { 48 8B D0 48 8D 0D 21 44 01 00 E8 BB D5 FF FF 48 8D 15 5D DC 00 00 48 8B 8D 78 01 00 00 BA 01 00 00 00 48 89 45 30 48 C7 45 38 00 00 00 00 48 C7 45 40 00 00 00 00 48 C7 45 48 00 00 00 00 E8 9B D5 FF FF }
        // Creates binding handle to an RPC server
        $op5 = { 48 8B C8 48 85 C9 74 1C 48 8B 01 48 89 06 48 8B 50 30 48 89 46 08 48 8B 42 10 48 89 42 18 48 8B 42 20 48 89 42 28 48 8B 42 30 48 89 42 38 }
    condition:
        // Detect if at least 3 out of 5 sets of opcodes are present
        1 of ($op1, $op2, $op3, $op4, $op5)
  }
