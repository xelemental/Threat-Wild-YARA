rule sysmon_exploit {
    meta:
        author = "Elemental X"
        description = "Yara rule for detecting CVE-2022-41120 version 2"
        link = "https://github.com/Wh04m1001/SysmonEoP/tree/main/v1/"
    strings:
        // First set of opcodes
        $op1 = { 48 C7 44 24 30 00 00 00 00 C7 44 24 28 00 00 20 06 C7 44 24 20 03 00 00 00 45 33 C9 41 B8 07 00 00 00 BA 00 01 01 00 48 8D 0D E0 E6 00 00 FF 15 D2 8D 01 00 48 89 05 5B 53 01 00}
        // Second set of opcodes
        $op2 = { 41 B8 04 00 00 00 33 D2 48 8D 0D FA D7 00 00 FF 15 AC 85 01 00 89 85 24 01 00 00 48 8D 0D 3F D8 00 00 E8 72 D1 FF FF 48 8B D0 48 8D 0D 40 41 01 00 E8 9A D6 FF FF  }
        // Third set of opcodes
        $op3 = { 89 45 04 48 8D 4D 28 FF 15 47 8F 01 00 89 45 04 4C 8D 45 70 BA DC 0B 00 00 48 8B 4D 48 E8 BE E1 FF FF}
    condition:
        // Detect if at least 2 out of 5 sets of opcodes are present
        all of ($op1, $op2, $op3)
  }
